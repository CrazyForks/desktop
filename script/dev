#!/bin/bash

# Function to display help
show_help() {
    echo "Usage: script/dev [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  -p --profile VALUE   Start with the given dev profile"
    echo "  -s --no-sync         Start with automatic sync disabled"
    echo "  -d --devtools        Start with devtools opened"
    echo "  -h --help            Display this help message and exit"
    echo ""
}

# Parse command line arguments
PROFILE=""
NO_SYNC=""
DEVTOOLS=""
while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--profile)
            PROFILE="$2"
            shift 2
            ;;
        -s|--no-sync)
            NO_SYNC="1"
            shift
            ;;
        -d|--devtools)
            DEVTOOLS="1"
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo "Unknown argument: $1"
            echo ""
            show_help
            exit 1
            ;;
    esac
done

# Function to check if a port is available
check_port() {
    nc -z localhost $1 >/dev/null 2>&1
    return $?
}

# Start with default port
PORT=1420

# If default port is in use, find next available port
if check_port $PORT; then
    while check_port $PORT; do
        PORT=$((PORT + 1))
    done

    # Create config file with new port
    CONFIG_FILE="backend/tauri-port-${PORT}.conf.json"
    cat > "$CONFIG_FILE" << EOF
{
  "build": {
    "devUrl": "http://localhost:${PORT}"
  }
}
EOF

    # Run Tauri with custom config and optional profile
    if [ -n "$PROFILE" ]; then
        DEV_PREFIX="$PROFILE" NO_SYNC="$NO_SYNC" DEVTOOLS="$DEVTOOLS" pnpm run tauri dev --config "$CONFIG_FILE"
    else
        NO_SYNC="$NO_SYNC" DEVTOOLS="$DEVTOOLS" pnpm run tauri dev --config "$CONFIG_FILE"
    fi
else
    # Run Tauri with default config and optional profile
    if [ -n "$PROFILE" ]; then
        DEV_PREFIX="$PROFILE" NO_SYNC="$NO_SYNC" DEVTOOLS="$DEVTOOLS" pnpm run tauri dev
    else
        NO_SYNC="$NO_SYNC" DEVTOOLS="$DEVTOOLS" pnpm run tauri dev
    fi
fi
